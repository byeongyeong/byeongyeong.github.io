---
layout: post
title: iOS 앱은 어떻게 실행될까?
tags:
  - TIL
  - UIKit
  - iOS
---

iOS 앱의 첫화면이 보여지기 전까지 어떤 실행과정을 거치는지 알아본다.
이 과정에서 중요한 함수나 객체들은 좀 더 자세하게 알아본다.

## 🧩 iOS 앱의 실행과정
실행과정은 아래와 같다.

> 1. main 함수 실행
2. UIKit 프레임워크의 [UIApplicationMain(_ : _ : _ : _ :)](https://developer.apple.com/documentation/uikit/1622933-uiapplicationmain) 함수 실행
  - 1) [UIApplication](https://developer.apple.com/documentation/uikit/uiapplication) 싱글턴 객체 생성
  - 2) AppDelegate 객체와 연결(delegate 설정)
  - 3) [UIApplication](https://developer.apple.com/documentation/uikit/uiapplication) 객체가 info.plist 파일에서 앱 실행에 필요한 데이터와 객체 로드
  - 4) [UIApplication](https://developer.apple.com/documentation/uikit/uiapplication) 객체가 Main Event Loop를 생성하고 관리
  - 5) (Info.plist에 main NIB이 세팅된 경우) [UIApplication](https://developer.apple.com/documentation/uikit/uiapplication) 객체가 main NIB 파일에서 main UI 로드
3. AppDelegate의 [application(_:willFinishLaunchingWithOptions:)](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623032-application) 호출
4. AppDelegate 및 ViewControllers의 추가 메서드를 호출하여 앱 상태 복원
5. AppDelegate의 [application(_:didFinishLaunchingWithOptions:)](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622921-application) 호출
6. (Info.plist에 main NIB이 세팅되지 않은 경우) main UI 로드
7. 앱 이벤트 루프에서 이벤트 핸들링 시작
8. 첫화면 BAAM!

<br>

실행과정 플로우차트는 아래와 같다. 두 플로우차트의 차이점은 main UI를 로드하는 시점이라고 할 수 있다.

첫번째 플로우차트는 main UI를 [application(_:didFinishLaunchingWithOptions:)](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622921-application) 함수가 실행될 때 로드한다. 이는 앱의 Info.plist 파일에 main NIB 파일을 지정하지 않아서 main UI를 로드하기 위한 별도의 로직을 추가해야하기 때문이다.

반면 두번째 플로우차트는 Info.plist에 main NIB을 지정한 케이스이기 때문에 [UIApplicationMain(_ : _ : _ : _ :)](https://developer.apple.com/documentation/uikit/1622933-uiapplicationmain) 함수가 실행될 때 main UI를 로드한다.

<br>

<p align="center">
   <img src="../images/2021-05-17-til-20210517/1.png" width="700" />
   <em style="font-size: 0.7em;">첫번째 플로우차트 - 출처: Revisiting the App Launch Sequence on iOS</em>
</p>
<br>

<p align="center">
   <img src="../images/2021-05-17-til-20210517/2.png" width="600" />
   <em style="font-size: 0.7em;">두번째 플로우차트 - 출처: StackOverFlow</em>
</p>

<br>

이제 실행과정을 자세하게 확인해본다.

<br>

## 🔑 main 함수와 UIApplicationMain
main.m 파일 안에서 main 함수를 확인할 수 있는 Objective-C와 다르게, Swift에는 main 함수가 노출되어있지 않다.
만약 Swift에서 main 함수를 커스텀하고 싶다면, 자동 생성되는 Appdelegate.swift 파일에서 
`@UIApplicationMain` 어노테이션을 없앤 후에 main.swift 파일을 별도 생성하고 아래 함수를 추가하면 된다.

~~~ swift
import UIKit

UIApplicationMain(CommandLine.argc,
                  UnsafeMutableRawPointer(CommandLine.unsafeArgv).bindMemory(
                      to: UnsafeMutablePointer<Int8>.self,
                      capacity: Int(CommandLine.argc)),
                  nil,
                  NSStringFromClass(AppDelegate.self))
~~~

main 함수에서 실행되는 [UIApplicationMain(_ : _ : _ : _ :)](https://developer.apple.com/documentation/uikit/1622933-uiapplicationmain) 함수는 위의 실행과정에서 확인했듯이 앱 실행에 필요한 다양한 동작을 수행한다.

공식문서에서 [UIApplicationMain(_ : _ : _ : _ :)](https://developer.apple.com/documentation/uikit/1622933-uiapplicationmain) 함수의 선언부분을 보면 아래와 같다.

<p align="center">
   <img src="../images/2021-05-17-til-20210517/3.png" width="700"/>
</p>

3,4번째 파라미터인 principalClassName와 delegateClassName 는 각각 [UIApplication](https://developer.apple.com/documentation/uikit/uiapplication) 클래스 이름과 AppDelegate로 초기화될 클래스 이름이다. 두 클래스 이름으로 [UIApplication](https://developer.apple.com/documentation/uikit/uiapplication) 객체와 AppDelegate를 생성하여 연결하고 Run Loop를 포함한 Main Event Loop를 세팅한다.

<br>


## 결론
앱의 실행과정과 함께 [UIApplicationMain(_ : _ : _ : _ :)](https://developer.apple.com/documentation/uikit/1622933-uiapplicationmain), [UIApplication](https://developer.apple.com/documentation/uikit/uiapplication), AppDelegate도 함께 알아보았다. 다음 번엔 iOS 앱의 구조와 함께 Main Event Loop도 조금 더 자세하게 알아 볼 예정이다.

## 레퍼런스
- [https://oleb.net/blog/2012/02/app-launch-sequence-ios-revisited/](https://oleb.net/blog/2012/02/app-launch-sequence-ios-revisited/)
- [https://stackoverflow.com/questions/17366107/what-is-the-launch-sequence-of-an-ios-app](https://stackoverflow.com/questions/17366107/what-is-the-launch-sequence-of-an-ios-app)


- [https://developer.apple.com/documentation/uikit/app-and-environment/responding-to-the-launch-of-your-app/about-the-app-launch_sequence](https://developer.apple.com/documentation/uikit/app_and_environment/responding_to_the_launch_of_your_app/about_the_app_launch_sequence)
- [https://medium.com/@anandin02/ios-application-launch-sequence-a13a267d1669](https://medium.com/@anandin02/ios-application-launch-sequence-a13a267d1669)
- [https://zeddios.tistory.com/218](https://zeddios.tistory.com/218)
- [https://zeddios.tistory.com/1049](https://zeddios.tistory.com/1049)
- [https://velog.io/@delmasong/App-Delegate](https://velog.io/@delmasong/App-Delegate)